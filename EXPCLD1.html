<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Participación</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            flex-direction: column;
            align-items: center;
        }
        .form-container {
            max-width: 600px;
            width: 100%;
           
            background-color: #fff;
          
            border-top: 8px solid #673ab7;
            border-radius: 8px;
      
            padding: 20px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }


        .photo-container {
            max-width: 600px;
            width: 100%;
            height: 70vh;
            background-color: #fff;
          
            border-top: 8px solid #673ab7;
            border-radius: 8px;
      
            padding: 20px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        .title {
            font-size: 32px;
            font-weight: bold;
            color: #202124;
            margin-bottom: 12px;
        }
        .sub {
            font-size: 12px;
            color: #202124;
            margin-bottom: 12px;
        }
        .question-block {
            background-color: #f9f9f9;
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .question {
            font-size: 18px;
            font-weight: bold;
            color: #202124;
            margin-bottom: 12px;
        }
        input[type="text"], input[type="email"], input[type="time"], input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="time"]:focus, select:focus {
            border-color: #673ab7;
            outline: none;
        }
        button {
            background-color: #673ab7;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #311b92;
        }
        a {
            color: #673ab7;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        
        /* Image task styling */
        #studyPhase, #testPhase {
            max-width: 600px;
            width: 100%;
            background-color: #fff;
            
            border-top: 8px solid #673ab7;
            border-radius: 8px;
            box-shadow: 0px 3px 8px rgba(0, 0, 0, 0.1);
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
            display: none;
        }
        
        .image-container {
            text-align: center;
            margin: 4px 0;
        }
        
        .task-image {
            max-width: 100%;
            max-height: 80vh;
          
            border-radius: 4px;
            margin-bottom: 10px;
            opacity: 1;
            transition: opacity 0.5s;
        }
        
        .response-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .response-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            min-width: 100px;
        }
        
        #yesBtn {
            background-color: #4CAF50;
            color: white;
        }
        
        #noBtn {
            background-color: #c90909;
            color: white;
        }
        
        #dontKnowBtn {
            background-color: #2196F3;
            color: white;
        }
        
        .response-btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }
        
        .progress-text {
            margin-top: 20px;
            font-weight: bold;
            font-size: 16px;
        }
        
        #countdown {
            display: none; 
            font-size: 20px; 
            white-space: pre-wrap;
            max-width: 600px;
            width: 100%;
            background-color: #fff;
            border: 1px solid #dadce0;
            border-top: 8px solid #673ab7;
            border-radius: 8px;
            box-shadow: 0px 3px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        
        #continuationSection {
            display: none;
            max-width: 600px;
            width: 100%;
            background-color: #fff;
            border: 1px solid #dadce0;
            border-top: 8px solid #673ab7;
            border-radius: 8px;
            box-shadow: 0px 3px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        
        .fixation-cross {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            animation: fadeInOut 1s infinite;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        }
        
        /* Nuevos estilos para las animaciones */
        .fade-out {
            animation: fadeOut 0.5s forwards;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .transition-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 1000;
        }
        
        #betweenPhasesInstructions {
            display: none;
        }
    </style>
</head>
<body>

    <div class="form-container" id="contenedorForm">
        <div class="title">Formulario de Participación</div>
        <div class="sub">
            <h2 style="font-size: 24px; margin-bottom: 10px;">¡Hola!</h2>
            <p style="margin-bottom: 12px;">Este estudio forma parte de una investigación sobre memoria del Laboratorio de Sueño y Memoria (ITBA). Podes participar usando computadora, tablet o teléfono.</p>
            <ul style="margin: 12px 0; padding-left: 20px;">
                <li><strong>Requisitos:</strong> Tener entre 18 y 45 años, no consumir psicofármacos, y no tener desordenes de sueño diagnosticados.</li>
                <li><strong>Duración:</strong> El experimento está dividido en tres partes, que se realizan en tres días consecutivos. Cada una toma aproximadamente 10 minutos. Mañana y pasado mañana recibirás por mail el enlace correspondiente para completar la segunda y tercera parte.</li>
                <li><strong>Más información:</strong> Para información más detallada sobre el experimento, podes entrar <a href="https://docs.google.com/document/d/10XCRqtJnLpIeVg680qVrGveWnGGuc5GtsKOJ_BW0S5c/edit?usp=sharing" target="_blank">aquí</a>.</li>
            </ul>
            <p style="margin-bottom: 12px;">Este Protocolo fue aprobado por el Comité de Ética Humana (CEH), de la Facultad de Medicina UBA.</p>
            <p style="margin-bottom: 12px;">Para consultas específicas comunicate con la Lic. Candela Leon, al mail: cleon@itba.edu.ar, o la Dra Cecilia Forcato, al mail: cforcato@itba.edu.ar.</p>
              <p style="margin-bottom: 12px;"> La información recolectada durante este estudio será guardada confidencialmente dentro de lo que estipula la ley 25326 de protección de datos personales. Los resultados pueden ser publicados para propósitos científicos, pero la identidad de las personas participantes no será revelada.</p>
        </div>

        <form id="mainForm" action="https://docs.google.com/forms/d/e/1FAIpQLSe2EFZParwxK-S37_pMHtyCMowhwIRxwFhcqHGVWO2X2jIAKw/formResponse" method="POST" >
            <div class="question-block">
                <label class="question" for="email">Dirección de correo electrónico</label>
                <input type="email" id="email" name="entry.1190073540" placeholder="Ingresa tu correo electrónico" required>
            </div>

            <div class="question-block">
                <label class="question">¿Desde qué dispositivo estás realizando esta tarea?</label>
                <select name="entry.2120654582" required>
                    <option value="" disabled selected>Selecciona una opción</option>
                    <option value="Computadora">Computadora</option>
                    <option value="Telefono">Teléfono</option>
                    <option value="Tablet">Tablet</option>
                </select>
            </div>

            <div class="question-block">
                <label class="question">¿Das tu consentimiento para participar?</label>
                <select name="entry.402678851" required>
                    <option value="" disabled selected>Selecciona una opción</option>
                    <option value="SI">Sí</option>
                    <option value="NO">No</option>
                </select>
            </div>

            <div class="question-block">
                <label class="question" for="nombre">Nombre y apellido</label>
                <input type="text" id="nombre" name="entry.543210643" placeholder="Ingresa tu nombre completo" required>
            </div>

            <div class="question-block">
                <label class="question" for="edad">Edad</label>
                <input type="number" id="edad" name="entry.165872651" placeholder="Ingresa tu edad" required min="18" max="45">
            </div>

            <div class="question-block">
                <label class="question">Género</label>
                <select name="entry.843997443" required>
                    <option value="" disabled selected>Selecciona tu género</option>
                    <option value="Femenino">Femenino</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>

            <div class="question-block">
                <label class="question">¿Cuál es tu nivel educativo actual?</label>
                <select name="entry.2121646283" required>
                    <option value="" disabled selected>Selecciona tu nivel educativo</option>
                    <option value="Posgrado completo">Posgrado completo</option>
                    <option value="Secundario completo">Secundario completo</option>
                    <option value="Secundario incompleto">Secundario incompleto</option>
                    <option value="Universitario completo">Universitario completo</option>
                    <option value="Posgrado incompleto">Posgrado incompleto</option>
                    <option value="Universitario incompleto">Universitario incompleto</option>
                    <option value="Terciario incompleto">Terciario incompleto</option>
                    <option value="Terciario completo">Terciario completo</option>
                </select>
            </div>

            <div class="question-block">
                <label class="question">¿A qué hora te despertaste hoy?</label>
                <input type="text" name="entry.810565752"  placeholder="Ingresá la hora en formato 24 hs, por ejemplo: 07:30 o 18:45"  required>
            </div>


                        <div class="question-block">
                <label class="question">¿Consumiste café, mate u otra bebida estimulante (por ejemplo, bebidas energizantes como Speed) en las últimas seis horas?</label>
                <select name="entry.1287033660" id="stim" required>
                    <option value="" disabled selected>Selecciona una opción</option>
                    <option value="Si">Sí</option>
                    <option value="No">No</option>
                </select>
            </div>


                        <div class="question-block">
                <label class="question">¿Dormiste siesta hoy?</label>
                <select name="entry.615663639" id="nap" required>
                    <option value="" disabled selected>Selecciona una opción</option>
                    <option value="Si">Sí</option>
                    <option value="No">No</option>
                </select>
            </div>


            <div class="question-block">
                <label class="question">¿Consumís alguna medicación de forma crónica?</label>
                <select name="entry.221114551" id="medicacion_cronica" required>
                    <option value="" disabled selected>Selecciona una opción</option>
                    <option value="Si">Sí</option>
                    <option value="No">No</option>
                </select>
            </div>

            <div class="question-block" id="detalle_medicacion_block" style="display: none;">
                <label class="question">En caso de que consumas medicación de forma crónica, ¿Cuál/es?</label>
                <input type="text" name="entry.315741378" placeholder="Especifica la medicación">
            </div>

            <div class="question-block">
                <label class="question">¿Sufrís algún trastorno o desorden del sueño?</label>
                <select name="entry.1140039148" id="trastorno_sueno" required>
                    <option value="" disabled selected>Selecciona una opción</option>
                    <option value="Si">Sí</option>
                    <option value="No">No</option>
                </select>
            </div>

            <div class="question-block" id="detalle_trastorno_block" style="display: none;">
                <label class="question">Si respondiste "Sí" en la pregunta anterior, ¿Cuál es el trastorno o desorden?</label>
                <input type="text" name="entry.830809876" placeholder="Describe el trastorno">
            </div>

            <div class="question-block">
                <label class="question">¿Participaste en otro experimento de memoria anteriormente?</label>
                <select name="entry.1546566797" id="experimento_anterior" required>
                    <option value="" disabled selected>Selecciona una opción</option>
                    <option value="Si">Sí</option>
                    <option value="No">No</option>
                </select>
            </div>

            <div class="question-block" id="detalle_experimento_block" style="display: none;">
                <label class="question">Si respondiste "Sí" a la pregunta anterior, contanos de qué se trataba el experimento</label>
                <input type="text" name="entry.1966342366" placeholder="Describe el experimento">
            </div>



            <div class="question-block">
                <label class="question">GRADO DE SOMNOLENCIA:</label>
                <select name="entry.1053849261"  required>
                    <option value="" disabled selected>Marcá la opción que te identifique mejor en este momento.</option>
                    <option value=1>Me siento activo, vital, alerta, o bien despierto</option>
                    <option value=2>Funcionando a niveles altos, pero no completamente alerta</option>
                    <option value=3>Despierto, pero relajado; sensible, pero no completamente alerta</option>
                    <option value=4>Un poco confundido, decepcionado</option>
                    <option value=5>Confundido; pierdo interés en permanecer despierto; ralentizado</option>
                    <option value=6>Somnoliento, mareado, luchado contra el sueño; prefiero recostarme</option>
                    <option value=7>Ya no lucho contra el sueño, comenzaré a dormirme pronto; tengo pensamientos como sueños</option>
                    <option value=8>Dormido</option>
                </select>
            </div>







        <input type="hidden" name="entry.700564156" id="img2Response">
        <input type="hidden" name="entry.578696829" id="img2Time">
        <input type="hidden" name="entry.1846099994" id="img3Response">
        <input type="hidden" name="entry.1266411467" id="img3Time">
        <input type="hidden" name="entry.955814617" id="img4Response">
        <input type="hidden" name="entry.368502653" id="img4Time">
        <input type="hidden" name="entry.281848136" id="img5Response">
        <input type="hidden" name="entry.1415358376" id="img5Time">
        <input type="hidden" name="entry.901203518" id="img6Response">
        <input type="hidden" name="entry.551600816" id="img6Time">
        <input type="hidden" name="entry.874666398" id="img7Response">
        <input type="hidden" name="entry.1774748287" id="img7Time">
        <input type="hidden" name="entry.663993879" id="img8Response">
        <input type="hidden" name="entry.31742072" id="img8Time">
        <input type="hidden" name="entry.1624298721" id="img9Response">
        <input type="hidden" name="entry.2017633666" id="img9Time">
        <input type="hidden" name="entry.250557209" id="img10Response">
        <input type="hidden" name="entry.1631802898" id="img10Time">
        <input type="hidden" name="entry.2034845045" id="img11Response">
        <input type="hidden" name="entry.105270583" id="img11Time">


            <button type="button" onclick="showInstructions()">Seguir</button>
        </form>

     
    </div>

    <div id="denuevo" style="display: none;" class="form-container">
      <p class="question-block">
      Solo se puede participar una vez en esta tarea. Si tiene consultas,
      puede escribirnos al siguiente Email:
      <br>
      <br>
      Cleon@itba.edu.ar
      </p>
    </div>

    <div id="instrucciones" style="display:none;">
        <div class="form-container">
            Antes de comenzar el estudio vas a realizar una prueba para mostrarte el procedimiento. 
            <p>
                Ahora vas a ver una serie de imágenes. Las imágenes van a pasar solas. 
                Solo apretá el botón de "Comenzar el ensayo" y observalas con atención.          

            </p>
            <button onclick="startStudyPhase()" type="button" id="startTaskBtn">Comenzar el ensayo</button>
        </div>
    </div>




    <div id="instrucciones1" style="display:none;">
        <div class="form-container">
            <p>¡Ensayo terminado!</p>
            <p>Vamos a empezar con el experimento</p>

            <ul style="text-align: left;">
                Ahora vas a ver una serie de caras. Las imágenes van a pasar solas. 

                
            </ul>
            <p>Solo apretá el botón de "Comenzar" y observalas con atención. </p>
            <button onclick="startStudyPhase()" type="button" id="startTaskBtn">Comenzar</button>
        </div>
    </div>


    <!-- Pantalla de instrucciones entre fases -->
    <div id="betweenPhasesInstructions" class="form-container">
        <h2>Instrucciones para la siguiente fase</h2>
        <p>Ahora vas a volver a ver una serie de imagenes y podes elegir entre las siguientes opciones:  </p>
        <ul>
            <li>Si recordás haber visto la imagenes elegí la opción "VISTO"</li>
            <li>Si no la recordás elegí la opción "NO VISTO"</li>
            <li>Si te resulta familiar elegí la opción "FAMILIAR"</li>
        </ul>
        <p>Responde lo más rápido y preciso que puedas.</p>
        <button onclick="startTestPhase()">Comenzar fase de reconocimiento</button>
    </div>



        <!-- Pantalla de instrucciones entre fases -->
<div id="Agradecimiento" class="form-container" style="display:none;">
    <h2>Gracias por responder</h2>
    <p id="mañana" style="display: none;" >Mañana a esta hora vas a recibir un mail con el enlace para realizar la segunda parte.</p>

    <button id="sendFinalButton" onclick="finalSubmit()" style="display:none; margin-top: 20px;">
        Enviar mis respuestas
    </button>
    <p id="enviandoMsg" style="display: none; font-weight: bold; color: rgb(18, 0, 181);">Enviando respuestas...</p>
    <p id="enviadoMsg" style="display: none; font-weight: bold; color: rgb(0, 0, 0);">¡Tus respuestas fueron enviadas correctamente!</p>
</div>


        

    <!-- Study Phase (images shown for 2 seconds each) -->
    <div id="studyPhase">
        <div class="photo-container">
            <div class="image-container" >
                <div id="fixationCross" class="fixation-cross" style="display: none;"></div>
                <center><img id="studyImage" class="task-image" src="" alt="Imagen de estudio" style="display: none;"></center>
                <div id="studyProgress" class="progress-text" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Test Phase (images shown with response buttons) -->
    <div id="testPhase">
        <div class="photo-container">
            <div class="image-container">
                <center><img id="testImage" class="task-image" src="" alt="Imagen de prueba" style="display: none;"></center>
                <div class="response-buttons" style="display: none;">
                    <button id="yesBtn" class="response-btn" onclick="recordResponse('SI')">VISTO</button>
                    <button id="noBtn" class="response-btn" onclick="recordResponse('NO')">NO VISTO</button>
                    <button id="dontKnowBtn" class="response-btn" onclick="recordResponse('TAL VEZ')">FAMILIAR</button>
                </div>
                <div id="testProgress" class="progress-text" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Pantalla de transición -->
    <div id="imageTransition" style="display: none;" style="display: none; height: 400px; background-color: #f9f9f9; border: 1px dashed #ccc; margin: 20px 0; display: flex; justify-content: center; align-items: center;">
       
    </div>

    <div id="countdown"></div>

    <div id="continuationSection">
        <p id="continuationLink" style="display: none;"></p>
    </div>

    <script>



        // Variables para el tiempo de reacción
        let imageDisplayTime = 0;
        let reactionTimes = [];
        let fase=0;

        // Experiment configuration
        let grupoAleatorio = 5;
        let horasEspera = 5;
        
        // Image task variables
const imageUrls = [
  'E1.jpg',
  'E2.jpg',
  'E3.jpg',
  'E4.jpg',
  'E5.jpg',
  'E6.jpg',
  'E7.jpg',
  'E8.jpg',
  'E9.jpg',
  'E10.jpg'
];

const imageUrlsReordered = [
  'E3.jpg',
  'E1.jpg',
  'E7.jpg',
  'E9.jpg',
  'E2.jpg',
  'E5.jpg',
  'E10.jpg',
  'E6.jpg',
  'E4.jpg',
  'E8.jpg'
];


        // Image task variables
        const DummyimageUrls = [
        'dummy1.png',
            'dummy2.png',
            'dummy3.png',
        ];


                const DummyTestimageUrls = [
        'dummy1.png',
            'dummy3.png',
             'dummy2.png',
        ];
        let currentStudyIndex = 0;
        let currentDummyIndex = 0;
        let currentTestIndex = 0;
        let currentDummyTestIndex = 0;
        let imageResponses = [];
        let studyPhaseCompleted = false;
        let testPhaseCompleted = false;

        // Form functions
        function showInstructions() {
         
            if (validateForm()) {
                if(fase==1){
                    document.getElementById('instrucciones1').style.display = 'block';
                    document.getElementById('contenedorForm').style.display = 'none';

                }
                else{
                    document.getElementById('instrucciones').style.display = 'block';
                    document.getElementById('contenedorForm').style.display = 'none';

                }

            } else {
                alert('Por favor, completa todos los campos obligatorios antes de continuar.');
            }
        }

function validateForm() {
    const requiredFields = document.querySelectorAll('#mainForm [required]');
    let allFilled = true;

    requiredFields.forEach(field => {
        if (!field.value) {
            allFilled = false;
            field.style.borderColor = 'red';
        } else {
            field.style.borderColor = '#dadce0';
        }
    });

    // Validar campos condicionales visibles
    const conditionalFields = [
        {trigger: 'medicacion_cronica', field: 'detalle_medicacion_block'},
        {trigger: 'trastorno_sueno', field: 'detalle_trastorno_block'},
        {trigger: 'experimento_anterior', field: 'detalle_experimento_block'}
    ];

    conditionalFields.forEach(item => {
        const trigger = document.getElementById(item.trigger);
        const fieldBlock = document.getElementById(item.field);
        
        if (trigger.value === 'Si' && fieldBlock.style.display === 'block') {
            const input = fieldBlock.querySelector('input');
            if (!input.value) {
                allFilled = false;
                input.style.borderColor = 'red';
            } else {
                input.style.borderColor = '#dadce0';
            }
        }
    });
 allFilled = true;
    return allFilled;
}
        
        // Study Phase functions
        function startStudyPhase() {
            
            document.getElementById("instrucciones").style.display = "none";
            document.getElementById("instrucciones1").style.display = "none";
            document.getElementById("studyPhase").style.display = "block";
            showNextStudyImage();
        }

        function showNextStudyImage() {

if (fase==0){

    if (currentDummyIndex >= DummyimageUrls.length) {
                studyPhaseCompleted = true;
                document.getElementById("studyPhase").style.display = "none";
                
                // Mostrar pantalla de instrucciones entre fases
                document.getElementById("betweenPhasesInstructions").style.display = "block";
                return;
            }


}



            if (currentStudyIndex >= imageUrls.length) {
                studyPhaseCompleted = true;
                document.getElementById("studyPhase").style.display = "none";
                
                // Mostrar pantalla de instrucciones entre fases
                document.getElementById("betweenPhasesInstructions").style.display = "block";
                return;
            }
            

            if (fase==0){

            document.getElementById("studyProgress").textContent = 
                `Imagen ${currentDummyIndex + 1} de ${DummyimageUrls.length} `;}

                if (fase==1){
                document.getElementById("studyProgress").textContent = 
                `Imagen ${currentStudyIndex + 1} de ${imageUrls.length} `;}
            
            // Mostrar cruz de fijación por 1 segundo antes de cada imagen
            document.getElementById("fixationCross").style.display = "block";
            document.getElementById("studyImage").style.display = "none";
            
            setTimeout(() => {
                document.getElementById("fixationCross").style.display = "none";
                
                const img = new Image();


                if (fase==0){
                img.src = DummyimageUrls[currentDummyIndex];
                img.onload = function() {
                    document.getElementById("studyImage").src = DummyimageUrls[currentDummyIndex];
                    document.getElementById("studyImage").style.display = "block";
                    document.getElementById("studyImage").scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Mostrar imagen por 2 segundos luego pasar a la siguiente
                    setTimeout(() => {
                        currentDummyIndex++;
                        showNextStudyImage();
                    }, 3000);
                };
            }



            if (fase==1){




                img.src = imageUrls[currentStudyIndex];
                img.onload = function() {
                    document.getElementById("studyImage").src = imageUrls[currentStudyIndex];
                    document.getElementById("studyImage").style.display = "block";
                    document.getElementById("studyImage").scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Mostrar imagen por 2 segundos luego pasar a la siguiente
                    setTimeout(() => {
                        currentStudyIndex++;
                        showNextStudyImage();
                    }, 3000);
                };

            }



            }, 500);
        }

        // Test Phase functions
        function startTestPhase() {
            document.getElementById("betweenPhasesInstructions").style.display = "none";
            document.getElementById("testPhase").style.display = "block";
            showNextTestImage();
        }
        function showNextTestImage() {
            const buttons = document.querySelectorAll("#testPhase .response-buttons button");
buttons.forEach(btn => btn.disabled = false);


if(fase==0){
    if (currentDummyTestIndex>= DummyimageUrls.length) {
        testPhaseCompleted = true;
        document.getElementById("testPhase").style.display = "none";
        fase=1;
        showInstructions();
        return;
    }
} 



if (currentTestIndex >= imageUrlsReordered.length) {
        testPhaseCompleted = true;
        document.getElementById("testPhase").style.display = "none";
        imageTaskComplete()
        
        return;
    }

    // Ocultar imagen y botones, mostrar área de transición
    document.getElementById("testImage").style.display = "none";
    document.querySelector("#testPhase .response-buttons").style.display = "none";
    document.getElementById("imageTransition").style.display = "flex";



    if (fase==0){
    
    document.getElementById("testProgress").textContent = 
        `Imagen ${currentDummyTestIndex + 1} de ${DummyimageUrls.length} `;
    
    // Esperar 1 segundo antes de mostrar la siguiente imagen
    setTimeout(() => {
        document.getElementById("imageTransition").style.display = "none";
        
        const img = new Image();
        img.src =DummyTestimageUrls[currentDummyTestIndex];


        
        img.onload = function() {
            const testImage = document.getElementById("testImage");
            testImage.src = DummyTestimageUrls[currentDummyTestIndex];
            
            // Aplicar animación de fade-in solo a la imagen
            testImage.style.display = "block";
            testImage.classList.add("fade-in");
            
            setTimeout(() => {
                testImage.classList.remove("fade-in");
            }, 500);
            
            document.querySelector("#testPhase .response-buttons").style.display = "flex";
            imageDisplayTime = Date.now();
        };
    }, 1000);}




    if (fase==1){
    
    document.getElementById("testProgress").textContent = 
        `Imagen ${currentTestIndex + 1} de ${imageUrlsReordered.length} `;
    
    // Esperar 1 segundo antes de mostrar la siguiente imagen
    setTimeout(() => {
        document.getElementById("imageTransition").style.display = "none";
        
        const img = new Image();
        img.src = imageUrlsReordered[currentTestIndex];
        img.onload = function() {
            const testImage = document.getElementById("testImage");
            testImage.src = img.src;
            
            // Aplicar animación de fade-in solo a la imagen
            testImage.style.display = "block";
            testImage.classList.add("fade-in");
            
            setTimeout(() => {
                testImage.classList.remove("fade-in");
            }, 500);
            
            document.querySelector("#testPhase .response-buttons").style.display = "flex";
            imageDisplayTime = Date.now();
        };
    }, 1000);}


}

function recordResponse(response) {
        // Evitar múltiples clics: deshabilita todos los botones
    const buttons = document.querySelectorAll("#testPhase .response-buttons button");
    buttons.forEach(btn => btn.disabled = true);

    const testImage = document.getElementById("testImage");
    
    // Aplicar animación de fade-out solo a la imagen
    testImage.classList.add("fade-out");
    
    setTimeout(() => {
        const responseTime = Date.now();
        const reactionTime = responseTime - imageDisplayTime;
        
        imageResponses.push({
            imageIndex: currentTestIndex,
            imageUrl: imageUrls[currentTestIndex],
            response: response,
            reactionTime: reactionTime,
            responseTime: responseTime
        });
        
        testImage.style.display = "none";
        testImage.classList.remove("fade-out");
        document.querySelector("#testPhase .response-buttons").style.display = "none";

        if (fase==1){
            currentTestIndex++;
        }
        
        
        currentDummyTestIndex++;
        showNextTestImage();
    }, 500);
}
        function imageTaskComplete() {

            if(fase==0){
        return;
    }

// Asignar respuestas y tiempos de reacción a los campos ocultos del formulario
if (imageResponses.length >= 12) {
    document.getElementById('img2Response').value = imageResponses[3].response;
    document.getElementById('img2Time').value = imageResponses[3].reactionTime;

    document.getElementById('img3Response').value = imageResponses[4].response;
    document.getElementById('img3Time').value = imageResponses[4].reactionTime;

    document.getElementById('img4Response').value = imageResponses[5].response;
    document.getElementById('img4Time').value = imageResponses[5].reactionTime;

    document.getElementById('img5Response').value = imageResponses[6].response;
    document.getElementById('img5Time').value = imageResponses[6].reactionTime;

    document.getElementById('img6Response').value = imageResponses[7].response;
    document.getElementById('img6Time').value = imageResponses[7].reactionTime;

    document.getElementById('img7Response').value = imageResponses[8].response;
    document.getElementById('img7Time').value = imageResponses[8].reactionTime;

    document.getElementById('img8Response').value = imageResponses[9].response;
    document.getElementById('img8Time').value = imageResponses[9].reactionTime;

    document.getElementById('img9Response').value = imageResponses[10].response;
    document.getElementById('img9Time').value = imageResponses[10].reactionTime;

    document.getElementById('img10Response').value = imageResponses[11].response;
    document.getElementById('img10Time').value = imageResponses[11].reactionTime;

    document.getElementById('img11Response').value = imageResponses[12].response;
    document.getElementById('img11Time').value = imageResponses[12].reactionTime;
}



            
            if (!localStorage.getItem("HizoLaParte1?")) {
                localStorage.setItem("HizoLaParte1?", "YaHizoparte1CL");

            }

  
                document.getElementById('Agradecimiento').style.display = 'block';
document.getElementById('sendFinalButton').style.display = 'inline-block';

        }




      

        // Check if participant has already completed the task
         if (localStorage.getItem("HizoLaParte1?") === "YaHizoparte1CL") {
            document.getElementById("contenedorForm").style.display = "none";
            document.getElementById("instrucciones").style.display = "none";
            document.getElementById("instrucciones1").style.display = "none";
            
            document.getElementById('denuevo').style.display = 'block';
            
        }

        // Conditional field displays
        document.getElementById('medicacion_cronica').addEventListener('change', function() {
            document.getElementById('detalle_medicacion_block').style.display = this.value === 'Si' ? 'block' : 'none';
        });

        document.getElementById('trastorno_sueno').addEventListener('change', function() {
            document.getElementById('detalle_trastorno_block').style.display = this.value === 'Si' ? 'block' : 'none';
        });

        document.getElementById('experimento_anterior').addEventListener('change', function() {
            document.getElementById('detalle_experimento_block').style.display = this.value === 'Si' ? 'block' : 'none';
        });





function finalSubmit() {
  const btn = document.getElementById('sendFinalButton');
  const enviando = document.getElementById('enviandoMsg');
  const enviado = document.getElementById('enviadoMsg');
  const mañana = document.getElementById('mañana');
  const form = document.getElementById('mainForm');

  btn.disabled = true;
  enviando.style.display = 'block';
  enviado.style.display = 'none';

  const formData = new FormData(form);

  // Armá los datos de respaldo
  const respuestas = imageResponses.map(r => ({
    imageUrl: r.imageUrl,
    response: r.response,
    reactionTime: r.reactionTime
  }));

const payload = {
  email: "alguien@algo.com",
  respuestas: [
    { imageUrl: "img1.jpg", response: "SI", reactionTime: 1000 },
    { imageUrl: "img2.jpg", response: "NO", reactionTime: 2000 }
  ]
};

const encoded = new URLSearchParams();
encoded.append('json', JSON.stringify(payload));

const blob = new Blob([encoded.toString()], {
  type: 'application/x-www-form-urlencoded'
});

navigator.sendBeacon(
  'https://script.google.com/macros/s/AKfycbx4UypcrVa9WJlT3ls5MOvfZfiOBgPmLs4pf7fHjLNDJf44JMNHdEMnaJX4toZnOlLkfw/exec',
  blob
);


  // Envío principal al Google Form
  fetch(form.action, {
    method: 'POST',
    mode: 'no-cors',
    body: formData
  }).then(() => {
    enviando.style.display = 'none';
    enviado.style.display = 'block';
    btn.style.display = 'none';
    mañana.style.display = 'block';
  }).catch(() => {
    enviando.textContent = "No se pudieron enviar tus respuestas. Por favor, contactanos.";
    enviando.style.color = "red";
  });
}


    </script>
</body>
</html>


